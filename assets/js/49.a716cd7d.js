(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{450:function(s,a,t){"use strict";t.r(a);var e=t(0),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("blockquote",[a("p",[s._v("免费一年的阿里云DV证书到期，继续使用需要续费\n不想每年都折腾\n申请证书时，blog二级域名没通过，查了不是敏感词，发工单没回复")])]),s._v(" "),a("h2",{attrs:{id:"场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[s._v("#")]),s._v(" 场景")]),s._v(" "),a("ul",[a("li",[s._v("http不安全，会被监听，劫持后添加广告")]),s._v(" "),a("li",[s._v("免费的SSL证书")]),s._v(" "),a("li",[s._v("长期有效")]),s._v(" "),a("li",[s._v("服务器环境：CentOS 7, Nginx")])]),s._v(" "),a("h2",{attrs:{id:"安装客户端certbot-auto"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装客户端certbot-auto"}},[s._v("#")]),s._v(" 安装客户端certbot-auto")]),s._v(" "),a("ul",[a("li",[s._v("certbot-auto客户端用于获取let's encrypt的证书")]),s._v(" "),a("li",[s._v("certbot官网说，可通过仓库安装certbot。尝试过，部分主机有效，但是需要更新依赖")]),s._v(" "),a("li",[s._v("更通用的方式获取客户端")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://dl.eff.org/certbot-auto\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" a+x ./certbot-auto\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"获取ssl证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取ssl证书"}},[s._v("#")]),s._v(" 获取SSL证书")]),s._v(" "),a("ul",[a("li",[s._v("外网防火墙需要放开80,443端口")]),s._v(" "),a("li",[s._v("停止运行nginx")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx stop")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("获取证书，多个域名，独立服务(相对于nginx的静态网页服务)")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ ./certbot-auto certonly "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--standalone")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" yourdomain.com "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" sub.yourdomain.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("根据提示，输入必要信息，比如邮箱（我用了域名注册的邮箱）")]),s._v(" "),a("li",[s._v("完成后，证书存储在/etc/letsencrypt/live/yourdomain.com/")]),s._v(" "),a("li",[s._v("(备忘，无需执行)另一种获取证书的方式，静态网页服务")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ ./certbot-auto certonly "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--webroot")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /home/wwwroot/yourhtmlweb.com "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v("  yourhtmlweb.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"测试证书更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试证书更新"}},[s._v("#")]),s._v(" 测试证书更新")]),s._v(" "),a("ul",[a("li",[s._v("运行前，必须停止nginx，否则占用80端口报错")]),s._v(" "),a("li",[s._v("测试通过显示Congratulations")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("./certbot-auto renew --dry-run\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"配置nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置nginx"}},[s._v("#")]),s._v(" 配置nginx")]),s._v(" "),a("ul",[a("li",[s._v("在/etc/nginx/conf.d路径下，新建sub.yourdomain.com.conf文件，添加如下内容")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server_name sub.yourdomain.com\n    ssl on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_certificate   /etc/letsencrypt/live/yourdomain.com/fullchain.pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_certificate_key  /etc/letsencrypt/live/yourdomai.com/privkey.pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_session_timeout 5m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("NULL:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("aNULL:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("MD5:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ADH:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("RC4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_prefer_server_ciphers on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass http://127.0.0.1:8080"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("ul",[a("li",[s._v("启动nginx")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx start")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"定时任务更新证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#定时任务更新证书"}},[s._v("#")]),s._v(" 定时任务更新证书")]),s._v(" "),a("ul",[a("li",[s._v("免费证书90天后过期")]),s._v(" "),a("li",[s._v("let's encrypt支持自动续约")]),s._v(" "),a("li",[s._v("配置定时任务，每2个月更新")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crontab -e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" */2 * /home/alei/./certbot-auto renew --pre-hook "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"service nginx stop"')]),s._v(" --post-hook "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"service nginx start"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);