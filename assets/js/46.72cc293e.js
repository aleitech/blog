(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{433:function(s,t,a){"use strict";a.r(t);var e=a(0),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("免费一年的阿里云DV证书到期，继续使用需要续费\n不想每年都折腾\n申请证书时，blog二级域名没通过，查了不是敏感词，发工单没回复")])]),s._v(" "),t("h2",{attrs:{id:"场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[s._v("#")]),s._v(" 场景")]),s._v(" "),t("ul",[t("li",[s._v("http不安全，会被监听，劫持后添加广告")]),s._v(" "),t("li",[s._v("免费的SSL证书")]),s._v(" "),t("li",[s._v("长期有效")]),s._v(" "),t("li",[s._v("服务器环境：CentOS 7, Nginx")])]),s._v(" "),t("h2",{attrs:{id:"安装客户端certbot-auto"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装客户端certbot-auto"}},[s._v("#")]),s._v(" 安装客户端certbot-auto")]),s._v(" "),t("ul",[t("li",[s._v("certbot-auto客户端用于获取let's encrypt的证书")]),s._v(" "),t("li",[s._v("certbot官网说，可通过仓库安装certbot。尝试过，部分主机有效，但是需要更新依赖")]),s._v(" "),t("li",[s._v("更通用的方式获取客户端")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://dl.eff.org/certbot-auto\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" a+x ./certbot-auto\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"获取ssl证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获取ssl证书"}},[s._v("#")]),s._v(" 获取SSL证书")]),s._v(" "),t("ul",[t("li",[s._v("外网防火墙需要放开80,443端口")]),s._v(" "),t("li",[s._v("停止运行nginx")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx stop")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("获取证书，多个域名，独立服务(相对于nginx的静态网页服务)")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ ./certbot-auto certonly --standalone -d yourdomain.com -d sub.yourdomain.com\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("根据提示，输入必要信息，比如邮箱（我用了域名注册的邮箱）")]),s._v(" "),t("li",[s._v("完成后，证书存储在/etc/letsencrypt/live/yourdomain.com/")]),s._v(" "),t("li",[s._v("(备忘，无需执行)另一种获取证书的方式，静态网页服务")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ ./certbot-auto certonly --webroot -w /home/wwwroot/yourhtmlweb.com -d  yourhtmlweb.com\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"测试证书更新"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试证书更新"}},[s._v("#")]),s._v(" 测试证书更新")]),s._v(" "),t("ul",[t("li",[s._v("运行前，必须停止nginx，否则占用80端口报错")]),s._v(" "),t("li",[s._v("测试通过显示Congratulations")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("./certbot-auto renew --dry-run\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"配置nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置nginx"}},[s._v("#")]),s._v(" 配置nginx")]),s._v(" "),t("ul",[t("li",[s._v("在/etc/nginx/conf.d路径下，新建sub.yourdomain.com.conf文件，添加如下内容")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server_name sub.yourdomain.com\n    ssl on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_certificate   /etc/letsencrypt/live/yourdomain.com/fullchain.pem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_certificate_key  /etc/letsencrypt/live/yourdomai.com/privkey.pem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_session_timeout 5m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("NULL:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("aNULL:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("MD5:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ADH:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("RC4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ssl_prefer_server_ciphers on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass http://127.0.0.1:8080"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("ul",[t("li",[s._v("启动nginx")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx start")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"定时任务更新证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定时任务更新证书"}},[s._v("#")]),s._v(" 定时任务更新证书")]),s._v(" "),t("ul",[t("li",[s._v("免费证书90天后过期")]),s._v(" "),t("li",[s._v("let's encrypt支持自动续约")]),s._v(" "),t("li",[s._v("配置定时任务，每2个月更新")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crontab -e")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" */2 * /home/alei/./certbot-auto renew --pre-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"service nginx stop"')]),s._v(" --post-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"service nginx start"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])}),[],!1,null,null,null);t.default=n.exports}}]);